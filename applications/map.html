<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Conflict Urbanism: Colombia</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-rc.3/leaflet.css" />
  <!-- Bootstrap -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles -->
  <link rel="stylesheet" type="text/css" href="../css/project-specific.css">
  <link rel="stylesheet" type="text/css" href="../css/interactive_visualization.css">
  <link rel="stylesheet" type="text/css" href="../css/map.css">
  <!-- Google fonts -->
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,300i,400,700" rel="stylesheet">

</head>
<body>
  <!-- ******* Navbar ******* -->
  <!-- Fixed navbar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">CONFLICT URBANISM: COLOMBIA</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li class="active"><a href="map.html">MAP</a></li>
          <li><a href="animation.html">ANIMATION</a></li>
          <li><a href="interactiveViz.html">INTERACTIVE VISUALIZATION</a></li>
          <li><a href="about.html">ABOUT</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>

  <div id="map">
    <div id="masthead">
      <h1>COLOMBIA'S REPORTED INTERNALLY DISPLACED PEOPLE: 1985 - 2015</h1>
      <!-- <p style="text-align:center;">1985 - 2015</p> -->
      <!-- BUG PUT ORIGIN ON THE SAME LINE -->
      <div id="barLegend" style="height:2px;">
        <div style="width:50%; text-align:left; float:left;"><p>Origin</p></div>
        <div style="width:50%; text-align:right; float:left;"><p>Destination</p></div>
      </div>
      <div id="barLegend">
        <div class="bar4Legend" style="width:12.5%;height:1px;background:#ffffff;"></div>
        <div class="bar4Legend" style="width:12.5%;height:1px;background:#FFEADD;"></div>
        <div class="bar4Legend" style="width:12.5%;height:1px;background:#FFD6BB;"></div>
        <div class="bar4Legend" style="width:12.5%;height:2px;background:#FFC299;"></div>
        <div class="bar4Legend" style="width:12.5%;height:3px;background:#FFAD77;"></div>
        <div class="bar4Legend" style="width:12.5%;height:4px;background:#FF9955;"></div>
        <div class="bar4Legend" style="width:12.5%;height:5px;background:#ff8533;"></div>
        <div class="bar4Legend" style="width:12.5%;height:6px;"></div>
      </div>
      <div id="barLegend">
        <div style="width:12.5%; text-align:right; float:left;"><p>1,000</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>2,500</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>5,000</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>10,000</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>20,000</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>30,000</p></div>
        <div style="width:12.5%; text-align:right; float:left;"><p>40,000</p></div>
      </div>
      <div id="barLegend">
        <div style ="width:45%; text-align:right; float: left; height:47.5px;">
          <ul>
            <li><p></p></li>
            <li><p>Number of people affected</p></li>
          </ul>
        </div>
        <div style="width:auto; float: left;">
          <img alt="Small Icon" src="webmap/iconRef.png" style="width:40px;height:47.5px">
        </div>
        <div style="float:left; text-align:left; hieght:47.5px";>
          <ul style="list-style:none">
            <li><p> > 100,000</p></li>
            <li><p>50,000 - 100,000</p></li>
            <li><p> < 50,000</p></li>
          </ul>
        </div>
      </div>
<!--       <div id="weightKey">Municipality of Origin --- Municipality of Destination</div></li>
      <p>Forced Displacement routes</p> -->
      <p>Click on a municipality for more information</p>
    <!-- </div> -->
    <div id="console">
      <div id="image"></div>
      <div id="title"></div>
      <div id ="infoBars">
        <div id="population" class="bar"></div>
        <p id="ptext"></p>
        <div id="desplazados" class="bar"></div>
        <p id = "dtext"></p>
        <div id ="refugiados" class="bar"></div>
        <p id = "rtext"></p>
        <div id ="ipc" class = "bar"></div>
        <p id="itext"></p>
      </div>
    </div>
  </div>
  <svg>
    <defs>
      <linearGradient id='NE' spreadMethod="pad" x1="0" y1="100%" x2="100%" y2="0%">
        <stop offset='30%' stop-color='#ff7111' stop-opacity='1' />
        <stop offset='100%' stop-color='#FFFFFF' stop-opacity = '1'/>
      </linearGradient>
      <linearGradient id='NW' spreadMethod="pad" x1="100%" y1="100%" x2="0%" y2="0%">
        <stop offset='30%' stop-color='#ff7111' stop-opacity='1' />
        <stop offset='100%' stop-color='#FFFFFF' stop-opacity = '1'/>
      </linearGradient>
      <linearGradient id='SE' spreadMethod="pad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset='30%' stop-color='#ff7111' stop-opacity='1' />
        <stop offset='100%' stop-color='#FFFFFF' stop-opacity = '1'/>
      </linearGradient>
      <linearGradient id='SW' spreadMethod="pad" x1="100%" y1="0%" x2="0%" y2="100%">
        <stop offset='30%' stop-color='#ff7111' stop-opacity='1' />
        <stop offset='100%' stop-color='#FFFFFF' stop-opacity = '1'/>
      </linearGradient>
    </defs>
  </svg>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  <!-- 3rd party libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"></script>
  <script src="../js/leaflet-src.js"></script>
  <script type="text/javascript" src="https://d3js.org/d3-queue.v3.min.js"></script>
  <!--jquery-->
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="../js/leaflet-hash.js"></script>
  <script src="../js/stats.js"></script>
  <!-- End of 3rd party libraries -->

  <!-- Main tangram library -->
  <script src="https://mapzen.com/tangram/0.9/tangram.min.js"></script>

  <!-- Demo module -->
  <script>
  function parseQuery (qstr) {
    var query = {};
    var a = qstr.split('&');
    for (var i in a) {
      var b = a[i].split('=');
      query[decodeURIComponent(b[0])] = decodeURIComponent(b[1]);
    }
    return query;
  }

  map = (function () {
    'use strict';
    var map_start_location = [4.571028, -74.297231, 6]; // Bogota


    /*** URL parsing ***/
    var url_hash = window.location.hash.slice(1, window.location.hash.length).split('/');

    if (url_hash.length == 3) {
      map_start_location = [url_hash[1],url_hash[2], url_hash[0]];
      // convert from strings
      map_start_location = map_start_location.map(Number);
    }

    // determine the scene url and content to load during start-up

    // ************************** TEST YAML **************************************

    var scene_url = 'webmap/scene_files/test.yaml';

    // If there is a query, use it as the scene_url
    var query = parseQuery(window.location.search.slice(1));
    if (query.url) {
      scene_url = query.url;
    }

    /*** Map ***/
    //leaflet map variable
    var map = L.map('map', {
      "keyboardZoomOffset" : 1.,
      "minZoom" : 6,
      "maxZoom" : 11,
      "zoomControl" : true,
    }
  );

  //load YAML file for map terrain
  var layer = Tangram.leafletLayer({
    scene: scene_url,
  });

  //leaflet map Pane for labels
  map.createPane('labels');

  //LABELS from YAML file
  var positronLabels = Tangram.leafletLayer({
    // scene: 'webmap/scene_files/labels.yaml',
    scene: 'webmap/scene_files/labels_test.yaml', //********* TEST ********
    attribution: '<a href="http://c4sr.columbia.edu/" target="_blank">Center for Spatial Research</a> | <a href="http://rni.unidadvictimas.gov.co/RUV" target="_blank">Registro Único de Víctimas</a> | <a href="https://mapzen.com/tangram" target="_blank">Tangram</a> | &copy; OSM contributors | <a href="https://mapzen.com/" target="_blank">Mapzen</a>',
    pane: 'labels'
  });

  positronLabels.addTo(map);

  if (query.quiet) {
    layer.options.attribution = "";
    map.attributionControl.setPrefix('');
    window.addEventListener("load", function() {
      var div = document.getElementById("mz-bug");
      if (div != null) {div.style.display = "none";}
      div = document.getElementById("mz-citysearch");
      if (div != null) {div.style.display = "none";}
      div = document.getElementById("mz-geolocator");
      if (div != null) {div.style.display = "none";}
    });
  }

  if (query.noscroll) {
    map.scrollWheelZoom.disable();
  }

  window.layer = layer;
  var scene = layer.scene;
  window.scene = scene;

  map.setView(map_start_location.slice(0, 3), map_start_location[2]);

  var hash = new L.Hash(map);

  layer.addTo(map);
  return map;

  }());

  //Limit users panning ability of the map
  map.setMaxBounds([[17, -60], [-6,-85]]);
  //********* END OF MAPZEN CODE

  var lookup={}
  for (i = 0; i<csv.length; i++)
  {
  lookup[csv[i][3]]=csv[i][0];
  }

  var selectedMunicip;
  var myFileName = 'data/SelectedMunicipalities.tsv'
  parseMyFile(myFileName);

  function parseMyFile(myFileName) {
    var q = d3.queue();
    q.defer(function(callback) {
      d3.tsv(myFileName, function(res) {
        //Passes data to the queue once we have loaded datat
        callback(null, res);
      });
    });
    //Once data has loaded, execute rest of code
    q.await(restOfCode);
  };

  // #############################################################################
  // ################# AFTER DATA HAS LOADED, RUN THE REST #######################
  // #############################################################################

  function getAllElementsWithAttribute(attribute, attributeString)
  {
    var matchingElements = [];
    var allElements = document.getElementsByTagName('*');
    for (var i =0, n = allElements.length; i<n; i++)
    {
      if (allElements[i].getAttribute(attribute) === attributeString)
      {
        matchingElements.push(allElements[i]);
      }
    }
    return matchingElements;
  }

  //on marker click, open data tray
  //save the ID of the last clicked city
  var lastClicked=0;
  function markerClick(city){
    var mapDiv = document.getElementById("console");
    var paths = document.getElementsByTagName('path');
    [].forEach.call(paths, function(test){
      test.setAttribute("hide","1");
    });
    //grab the paths ending in our city and grab the image associated with our city
    var destinationPathsAndImage = Array.prototype.slice.call(document.getElementsByClassName(city));
    //grab all of the paths originatin in our clicked city
    var originPaths = getAllElementsWithAttribute('originCode', city);
    //combine all our desired html elements into one array
    var icon = Array.prototype.concat(originPaths, destinationPathsAndImage);

    lastClicked=city;
    [].forEach.call(icon, function(test){
      test.setAttribute("hide","0");
      test.setAttribute("display", 'block');
    });

    //remove irrelevant paths
    var paths = document.getElementsByTagName('path');
    [].forEach.call(paths, function(test){
      if(test.getAttribute("hide")>0){
        test.setAttribute("display",'none');
      };
    });

    //modify inner html
    var info = document.getElementById("image");
    var city_space = city.replace(/-/g,' ');
    var index = 0;
    for (i = 0;i<selectedMunicip.length; i++)
    {
      if (city === selectedMunicip[i].ID){
        info.innerHTML='<br>';
        info.innerHTML="<img src=webmap/img/Image_"+selectedMunicip[i].ID+".png>";
        info.style.display='block';
        index=i;
        break;
      }else if (i==selectedMunicip.length-1){
        info.style.display='none';
      }
    }
    $('#title').html(selectedMunicip[index].NAME);

    //Determine max bar length based off of div sizes
    var thisMunicipPop = parseInt(selectedMunicip[index].POPULATION);
    var thisMunicipDisplaced = parseInt(selectedMunicip[index].DISPLACED);
    var thisMunicipRefugees = parseInt(selectedMunicip[index].REFUGEES);
    var thisMunicipIDPS = parseInt(selectedMunicip[index].IDPS);

    var maxBarLen = Math.max(thisMunicipPop, thisMunicipDisplaced, thisMunicipRefugees, thisMunicipIDPS);

    mapDiv.style.visibility="visible";

    $("#population").animate({'width':''+100*thisMunicipPop/maxBarLen+"%"});
    document.getElementById("ptext").innerHTML=""+ thisMunicipPop +" | Population (2005)";
    $("#desplazados").animate({'width':''+100*thisMunicipDisplaced/maxBarLen+"%"});
    document.getElementById("dtext").innerHTML=""+ thisMunicipDisplaced +" | Displaced (1985-2015)";
    $("#refugiados").animate({'width':''+100*thisMunicipRefugees/maxBarLen+"%"});
    document.getElementById("rtext").innerHTML=""+ thisMunicipRefugees +" | Refugees (1985-2015)";
    $("#ipc").animate({'width':''+100*thisMunicipIDPS/maxBarLen+"%"});
    document.getElementById("itext").innerHTML=""+ thisMunicipIDPS +" | IDP's (1985-2015)";
    $(mapDiv).fadeTo(1000,1)

  };

  function getCity(index){
    return selectedMunicip[index];
  };

  function restOfCode(err, results) {
    //Load tsv data
    selectedMunicip = results;


    //USE D3 TO LOAD VECTORS AS SVG ELEMENTS
    var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    //g element groups svg's together (html syntax)
    g = svg.append("g").attr("class", "leaflet-zoom-hide");

    //d3 function to read the geojson to an array
    d3.json("webmap/DisplacementLargeEdited_100+.geojson", function(error, collection) {
    if (error) throw error;

    //call function below to map geo points to screen coordinates
    var transform = d3.geo.transform({point: projectPoint}),
    path = d3.geo.path().projection(transform);

    var feature = g.selectAll("path")
    .attr("class","vector")
    .data(collection.features)
    .enter().append("path");

    //for loop calculates stroke for every line on the map
    //gradient must be chosen based on direction of line
    //happens ONCE
    //later positions of the lines are recalculated but appearance is constant
    for (i=0; i<collection.features.length;i++)
    {
      var direction;
      var directionLon = collection.features[i].properties.OrgLon-collection.features[i].properties.DestLon;
      var directionLat = collection.features[i].properties.OrgLat-collection.features[i].properties.DestLat;
      if (directionLon>0)
      {
        if (directionLat>0){
          direction = "NE";
          feature[0][i].setAttribute("direction", "NE");
          feature[0][i].setAttribute("stroke","url(#NE)");
        }
        else{
          direction = "SE";
          feature[0][i].setAttribute("direction", "SE");
          feature[0][i].setAttribute("stroke","url(#SE)");
        }
      }
      else{
        if (directionLat>0){
          direction = "NW";
          feature[0][i].setAttribute("direction", "NW");
          feature[0][i].setAttribute("stroke","url(#NW)");
        }
        else{
          direction = "SW";
          feature[0][i].setAttribute("direction", "SW");
          feature[0][i].setAttribute("stroke","url(#SW)");
        }
      }
      // feature[0][i].setAttribute("class",collection.features[i].properties.DestMun.replace(/\s+/g, '-').replace(',',''));
      feature[0][i].setAttribute("class", String(collection.features[i].properties.Dest));
      feature[0][i].setAttribute("stroke-width",getLineWeight(collection.features[i].properties.Count));
      feature[0][i].setAttribute("destination",collection.features[i].properties.DestMun);
      feature[0][i].setAttribute("origin",collection.features[i].properties.OrgMun.replace(/\s+/g, '-').replace(',',''));
      feature[0][i].setAttribute("destination", collection.features[i].properties.DestMun.replace(/\s+/g, '-').replace(',',''));
      feature[0][i].setAttribute("hide", "1");
      feature[0][i].setAttribute("originCode", String(collection.features[i].properties.Origin));
      feature[0][i].setAttribute("destinationCode", String(collection.features[i].properties.Dest));
      feature[0][i].setAttribute("odPair", String(collection.features[i].properties.OD_Pair));
    }

    map.on("viewreset", reset);
    reset();

    // Reposition the SVG to cover the features.
    function reset() {
      $('svg').css("display","none");
      var bounds = path.bounds(collection),
      topLeft = bounds[0],
      bottomRight = bounds[1];
      svg.attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px");
      g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
      feature.attr("d", path);
      setTimeout(function(){$('svg').css("display","block");},50);
    }

    // Use Leaflet to implement a D3 geometric transformation.
    function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }
    });

    //returns a line weight scaled to number of ppl displaced
    function getLineWeight(c) {
    return c > 40000  ? 6 :
    c > 30000  ? 5 :
    c > 20000  ? 4 :
    c > 10000  ? 3 :
    c > 5000   ? 2 :
    c > 2500   ? 0.7 :
    c > 1000   ? 0.4 :
    0.2;
    };

    //proportionally sized icons
    var smallIcon = L.icon({
      iconUrl: 'webmap/icon2.png',
      iconSize: [17, 20.1875],
      iconAnchor: [10, 10], //    iconAnchor: [10, 23.5/2],
      popupAnchor: [-0.75, -16.5]
    });
    var mediumIcon = L.icon({
      iconUrl: 'webmap/icon2.png',
      iconSize: [30, 35.625],
      iconAnchor: [15, 15],            // formerly iconAnchor: [15, 35.625/2],
      popupAnchor: [-0.75, -16.5]
    });
    var largeIcon = L.icon({
      iconUrl: 'webmap/icon2.png',
      iconSize: [40, 47.5],
      iconAnchor: [20, 20],           // formerly 20, 23.75
      popupAnchor: [-0.75, -16.5]
    });
    function chooseIcon(population){
      if (population<50000){
        return smallIcon;
      } else if (population<100000){
        return mediumIcon;
      } else{
        return largeIcon;
      }
    }


    //add icons for all municipalities in our dataset, the tsv
    for (j=0; j< selectedMunicip.length; j++)
    {
      var marker = L.marker([selectedMunicip[j].LATITUDE, selectedMunicip[j].LONGITUDE],
      {
        icon: chooseIcon(selectedMunicip[j].TOTAL_IMPACT),
        opacity: 1}
      )
      .addTo(map);
      var icon = document.getElementsByClassName("leaflet-marker-icon")[j];
      icon.className+=" "+selectedMunicip[j].ID;
      icon.setAttribute("onclick", 'markerClick(this.classList.item(3))');
    };



    //reset lines when the map terrain is clicked but not when mouse terrain is dragged
    var isDragging = false;
    var startingPos = [];
    $(document)
      .mousedown(function (evt) {
        isDragging = false;
        startingPos = [evt.pageX, evt.pageY];
      })
      .mousemove(function(evt) {
        if(!(evt.pageX === startingPos[0] && evt.pageY === startingPos[1])) {
          isDragging = true;
        }
      })
      .mouseup( function () {
        if (isDragging) {
        } else {
          if (event.target.classList.item(3)!=lastClicked){
            var mapDiv = document.getElementById("console");
            var paths = document.getElementsByTagName('path');
            [].forEach.call(paths, function(test){
              test.setAttribute("display", 'block');
              test.setAttribute("hide","1");
            });
            setTimeout(function(){
            }, 1000);
            // $(mapDiv).fadeTo(1000,0);    //fade bug
          }
        }
        isDragging = false;
        startingPos = [];
      });
  };

    </script>
    <!-- Mapzen map UI -->
    <script src='//mapzen.com/common/ui/mapzen-ui.min.js'></script>
  </body>
  </html>
